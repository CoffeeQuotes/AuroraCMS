window.elFinderSupportVer1=function(e){var d=this,b,c,f,a=function(g){return g.replace("Today",c).replace("Yesterday",f)};b=new Date();c=b.getFullYear()+"/"+(b.getMonth()+1)+"/"+b.getDate();b=new Date(Date.now()-86400000);f=b.getFullYear()+"/"+(b.getMonth()+1)+"/"+b.getDate();this.upload=e||"auto";this.init=function(g){this.fm=g;this.fm.parseUploadData=function(j){var h;if(!$.trim(j)){return{error:["errResponse","errDataEmpty"]}}try{h=JSON.parse(j)}catch(i){return{error:["errResponse","errDataNotJSON"]}}return d.normalize("upload",h)}};this.send=function(g){var o=this,l=this.fm,h=$.Deferred(),i=g.data.cmd,k=[],m={},j,n;h.abort=function(){if(n.state()=="pending"){n.quiet=true;n.abort()}};switch(i){case"open":g.data.tree=1;break;case"parents":case"tree":return h.resolve({tree:[]});case"get":g.data.cmd="read";g.data.current=l.file(g.data.target).phash;break;case"put":g.data.cmd="edit";g.data.current=l.file(g.data.target).phash;break;case"archive":case"rm":g.data.current=l.file(g.data.targets[0]).phash;break;case"extract":case"rename":case"resize":g.data.current=l.file(g.data.target).phash;break;case"duplicate":m=$.extend(true,{},g);$.each(g.data.targets,function(p,q){$.ajax(Object.assign(m,{data:{cmd:"duplicate",target:q,current:l.file(q).phash}})).fail(function(r){l.error(l.res("error","connect"))}).done(function(r){r=o.normalize("duplicate",r);if(r.error){l.error(r.error)}else{if(r.added){l.trigger("add",{added:r.added})}}})});return h.resolve({});case"mkdir":case"mkfile":g.data.current=g.data.target;break;case"paste":g.data.current=g.data.dst;if(!g.data.tree){$.each(g.data.targets,function(p,q){if(l.file(q)&&l.file(q).mime==="directory"){g.data.tree="1";return false}})}break;case"size":return h.resolve({error:l.res("error","cmdsupport")});case"search":return h.resolve({error:l.res("error","cmdsupport")});case"file":g.data.cmd="open";g.data.current=l.file(g.data.target).phash;break}n=$.ajax(g).fail(function(p){h.reject(p)}).done(function(p){j=o.normalize(i,p);h.resolve(j)});return h};this.normalize=function(j,l){var r=this,o=this.fm,g={},i=function(s){return s&&s.hash&&s.name&&s.mime?s:null},h=function(s){return $.grep(s,function(t){return t&&t.mime&&t.mime==="directory"?true:false})},q=function(s){var u=h(s);k=o.diff(u,null,["date","ts"]);if(k.added.length){k.added=h(k.added)}if(k.changed.length){k.changed=h(k.changed)}if(k.removed.length){var t=[];$.each(k.removed,function(v,w){var x;if((x=o.file(w))&&x.mime==="directory"){t.push(w)}});k.removed=t}return k},n,p,m,k;if((j=="tmb"||j=="get")){return l}if(j=="upload"&&l.error&&l.cwd){l.warning=Object.assign({},l.error);l.error=false}if(l.error){return l}if(j=="put"){n=o.file(l.target.hash).phash;return{changed:[this.normalizeFile(l.target,n)]}}n=l.cwd.hash;m=(n==o.cwd().hash);if(l.tree){$.each(this.normalizeTree(l.tree),function(t,s){g[s.hash]=s})}$.each(l.cdc||[],function(t,s){var u=s.hash,v;if(g[u]){if(s.date){v=Date.parse(a(s.date));if(v&&!isNaN(v)){g[u].ts=Math.floor(v/1000)}else{g[u].date=s.date||o.formatDate(s)}}g[u].locked=s.hash==n?true:s.rm===void (0)?false:!s.rm}else{g[u]=r.normalizeFile(s,n,l.tmb)}});if(!l.tree){$.each(o.files(),function(t,s){if(!g[t]&&s.phash!=n&&s.mime=="directory"){g[t]=s}})}if(j=="open"){return{cwd:g[n]||this.normalizeFile(l.cwd),files:$.map(g,function(s){return s}),options:r.normalizeOptions(l),init:!!l.params,debug:l.debug}}if(m){p=o.diff($.map(g,i))}else{if(l.tree&&j!=="paste"){p=q(g)}else{p={added:[],removed:[],changed:[]};if(j==="paste"){p.sync=true}}}return Object.assign({current:l.cwd.hash,error:l.error,warning:l.warning,options:{tmb:!!l.tmb}},p)};this.normalizeTree=function(h){var i=this,g=[],j=function(m,n){var l,k;for(l=0;l<m.length;l++){k=m[l];g.push(i.normalizeFile(k,n));k.dirs.length&&j(k.dirs,k.hash)}};j([h]);return g};this.normalizeFile=function(h,m,j){var i=h.mime||"directory",g=i=="directory"&&!h.linkTo?0:h.size,l=h.date?Date.parse(a(h.date)):void 0,k={url:h.url,hash:h.hash,phash:m,name:h.name,mime:i,ts:h.ts,size:g,read:h.read,write:h.write,locked:!m?true:h.rm===void (0)?false:!h.rm};if(!k.ts){if(l&&!isNaN(l)){k.ts=Math.floor(l/1000)}else{k.date=h.date||this.fm.formatDate(h)}}if(h.mime=="application/x-empty"||h.mime=="inode/x-empty"){k.mime="text/plain"}if(h.linkTo){k.alias=h.linkTo}if(h.linkTo){k.linkTo=h.linkTo}if(h.tmb){k.tmb=h.tmb}else{if(k.mime.indexOf("image/")===0&&j){k.tmb=1}}if(h.dirs&&h.dirs.length){k.dirs=true}if(h.dim){k.dim=h.dim}if(h.resize){k.resize=h.resize}return k};this.normalizeOptions=function(h){var g={path:h.cwd.rel,disabled:$.merge((h.disabled||[]),["search","netmount","zipdl"]),tmb:!!h.tmb,copyOverwrite:true};if(h.params){g.api=1;g.url=h.params.url;g.archivers={create:h.params.archives||[],extract:h.params.extract||[]}}if(g.path.indexOf("/")!==-1){g.separator="/"}else{if(g.path.indexOf("\\")!==-1){g.separator="\\"}}return g}};
